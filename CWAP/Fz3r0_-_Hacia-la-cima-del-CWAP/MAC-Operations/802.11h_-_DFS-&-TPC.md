
# üôãüõúüö¶MAC Operations: `802.11h` - `DFS` & `TPC`

![My Video](https://user-images.githubusercontent.com/94720207/165892585-b830998d-d7c5-43b4-a3ad-f71a07b9077e.gif)

### üê¶ Twitter  : [@fz3r0_OPs](https://twitter.com/Fz3r0_OPs)  || üê± Github  : [Fz3r0](https://github.com/fz3r0) 

---
 
#### Keywords: `Networking` `Wireless Networking` `IEEE 802.11` `Wi-Fi` `CWNA` `CWAP` `CWNE` `CCNP` `MAC Operations` `DFS` `DFS Protection`

---

<br>

# Index




# `802.11h` - `DFS` & `TPC`



802.11h was meant to bring two main features : `DFS` and `TPC`.

1. `DFS (Dynamic Frequency Selection)`: DFS is all about **detect RADAR** pulses and **move to other 5 GHz channel**. Based on **Spectrum** management (Layer 1) to ensures that channels containing **RADARs** are avoided by the **AP**. It is also used to reduce interference to **Satellites** <br> <br>
2. `TPC (Transmit Power Control)`: Initial 802.11h goal of TPC was to protect the EESS (Earth Exploration Satellite Services), so the TPC ensures that the average power on the 802.11 device (AP/STA) is less than the regulatory domain maximun to reduce interference to the EESS. This means that **the TPC mechanism limit the overall RF power/gain of 802.11 devices** so they don't interfere with the satellites. 
**Now it is used in ALL BANDS for other reasons such as reducing contention interference caused by client STAs.**







# 802.11h - `DFS (Dynamic Frequency Selection)`

Dynamic Frequency Selection (DFS) is a channel allocation scheme specified for 802.11 WLANs (Wi-Fi). It was standardized in 2003 as part of IEEE 802.11h.

DFS is all about radar `detection` and `avoidance`. It is designed to prevent electromagnetic interference by avoiding co-channel operation with systems that predated Wi-Fi, such as: 

- Military radar
- Satellite communication
- weather radar

It also to provide on aggregate a near-uniform loading of the spectrum (uniform spreading).

## DFS: `History`

RADAR avoidence rules first implemented in Europe by ETSI, FCC (USA) followed shortyle after.

In 2003, the IEEE ratified the 802.11h amandement which proposed two capabilitied for Wi-Fi radios:

1. DFS (Dynamic Frequency Selection)
2. TPC (Transmit Power Control)

## DFS: `DFS Rules`

The DFS rules are just "how" to transmit in a DFS channel aswell "how" to avoid interference. The DFS rules are not just for IEEE 802.11 (Wi-Fi) transmissions, they are made for all devices using the 5 GHz band, and each one of those devices should not interfere with a RADAR.

- `Note`: The DFS rules can change depending on each country, but for the most part are very similar. 

| **Concept**                     | **Description**                                                                                                                                                                                                                                  | **Max/Min Time**              |
|----------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|
| **`CAC (Channel Availability Check)`** | The time for which the system must monitor a channel for radar prior to any data being transmitted over the channel.                                                                                                                           | Normal DFS: _(max)_ **60 seconds**<br>Weather DFS: _(max)_ **600 seconds** |
| **`Channel Move Time`**            | The time taken by the system to vacate a channel. It's measured from the end of the radar burst to the end of the data transmission on that channel.                                                                                              | _(max)_ **10 seconds**                |
| **`NOP (Non-Occupancy Period)`**   | The period for which a radar-detected channel should not be used.                                                                                                                                                                               | _(at least)_ **30 minutes**          |
| **`NOL (Non-Occupancy List)`**     | A **list of channels** where the AP has detected radar presence within the last 30 minutes per timer.                                                                                                                                               | **Last 30 minutes**           |
| **`Channel Closing Time`**         | The time in which the AP must **cease data transmission** on the channel.                                                                                                                                                                           | **1 second**                  |
| **`In-Service Monitor`**           | AP monitors the operating channel for the presence of **ISM radar**.                                                                                                                                                                                | **Continuously**              |
| **`Master Device`**                | A device that **can detect** radar. (Typically an **AP**)                                                                                                                                                                                                | **AP**                        |
| **`Client Device`**                | A device that **cannot detect** radar. Instead, it relies on seeing valid data from the master device‚Äôs beacon frame.  (Typically a client **STA**)                                                                                                                             | **STA**                       |

- Because the 2.4 GHz band is free of RADAR, **the DFS rules only apply to the `5.250 -> 5.725 GHz band (UNNI-2 / UNNI-2 extended)`**.
- An AP, when moving to a new DFS channel, has to listen silently to the medium for one minute before it is allowed to transmit anything (like a beacon) in order to make sure that  no radar is currently operating on that channel. Clients do not have such a responsibility and are allowed to send wifi frames if an AP is already present and beaconing on the channel, this leaves all the responsibility on the shoulders of the AP.
- Certain channels like 120,124 and 128 have specific rules where an AP even has to wait 10 minutes before being able to use those channels.

## DFS: `5 GHz - UNNI & DFS Channels`

The 5 GHz band is a frequency range used for wireless communication, particularly in 802.11  (Wi-Fi) networks, offering multiple channels designated as **UNII channels (Unlicensed National Information Infrastructure)** for different uses. 

Introduced in the late 1990s and early 2000s, these channels provide wider bandwidth and less interference compared to the congested 2.4 GHz band. 

- However, **certain DFS (Dynamic Frequency Selection) channels within the UNII-2 Extended and UNII-2 bands are subject to radar detection due to their proximity to frequencies used by weather and aviation radars.**

These channels require devices to monitor for radar signals before transmitting to avoid interference, which can disrupt radar operations and compromise safety. The regulations were established to ensure that wireless devices could coexist with these critical radar systems.

![image](https://github.com/user-attachments/assets/b725da15-06a5-4688-ace4-fafe6cee9a15)

| **UNII Band**            | **Channels**                                                                                                                                                     | **Frequency**                | **Bandwidth (MHz)**     | **DFS**             | **Usage**                                |
|--------------------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------|-------------------------|---------------------|------------------------------------------|
| _**UNII-1**_               | _36, 40, 44, 48_                                                                                                                                                  | _5.150 GHz ‚Äì 5.250 GHz_         | _20/40/80_                | **NO**                  | _Indoor, no DFS requirements_              |
| **UNII-2a**               | **52, 56, 60, 64**                                                                                                                                                  | **5.250 GHz ‚Äì 5.350 GHz**         | **20/40/80**                | **YES**                | **Indoor/Outdoor with DFS requirements**     |
| **UNII-2c Extended**      | **100, 104, 108, 112, 116, 120, 124, 128, 132, 136, 140, 144**                                                                                                      | **5.470 GHz ‚Äì 5.725 GHz**         | **20/40/80/160**            | **YES**                 | **Indoor/Outdoor with DFS requirements**     |
| **UNII-2c Extended:** <br>**DFS Radar Channels**   | _116_, **120, 124, 128**, _132_                                                                                                                                         | **5.580 GHz ‚Äì 5.660 GHz**         | **20/40/80**                | **YES (High interference)** | **Prone to meteorological radar interference** |
| **UNII-3**               | 149, 153, 157, 161, 165                                                                                                                                         | 5.725 GHz ‚Äì 5.850 GHz         | 20/40/80                | No                  | Outdoor/Indoor, no DFS requirements      |

- **ALL** the channels in the `UNII-2a` & `UNII-2c` bands are known as `DFS Channels`.
- WLAN radios operating in these 5 GHz bands **must support DFS**, to protect WLAN communications from interfering with military or weather radar systems.
- If **radar pulses** are detected in **ANY of the DFS channels**, 802.11 APs and client STAs are not allowed to transmit on the same chanel. <br><br>
    - **`Good Practice`**: In most cases, **DFS channels should be usen**. Including DFS channels in the channel reuse pattern will help to **reduce the CCI** between same channels than can "hear" each other.

**`Important`**: Most current-day client devices are being certified to transmit on the DFS channels, and the inclusion of DFS channels in channel reuse patterns is becoming more commonplace. **There are still 802.11 devices out in the wild that cant't "hear" DFS channels tho!!!**

![image](https://github.com/user-attachments/assets/95617b6a-688e-4f83-8781-c1734cfe512c)

![efa44f3a40ebb8ae0e1215d05428031a_Design_Overview_5-6-removebg-preview](https://github.com/user-attachments/assets/7e288269-3b75-4e20-b2b8-5c00da4d5742)

## DFS: `Radars`

**Radar stands for **RAdio Detection And Ranging**. In the past, the Radars used to operate in frequency ranges where they were the only type of device operating there. **Now that regulatory agencies are opening those frequencies for other uses (like wireless LAN), there is a need for those devices to operate in accordance of the radars.** _(802.11a->DFS)_

There are 2 main types of Radars:

1. `Fixed`: Often **civilian airport** or **military base**, but also **weather radars**
2. `Mobile`: Ships 

Example Doppler Weather RADARs:

<p align="center"> 
<img src="https://github.com/user-attachments/assets/49bcdc64-ea53-462e-9ccd-d9084fb18e75" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/bd5c4883-00e7-4f13-b161-bb529b75c80a" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/bd5980a5-bb39-44a4-8378-00f309fb2cb3" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/d53461a1-1bf5-4e8d-bc8c-0b49bd71fa74" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/b1543e6f-f589-428c-8bec-3eb8706c0ece" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/fc467335-5210-47c9-b8d9-60a44410fa60" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/5a115dc9-4e2d-474c-bec5-b01f40503c02" width="300" height="300">
<img src="https://github.com/user-attachments/assets/72ef8052-e12d-46c7-adf1-308bfbfc3f41" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/74135025-fbb4-4f6c-99dc-5ae0584f4586" width="300" height="300"> 
</p>







### RADARs: RADAR Operation

The radar transmits a focused pulse of microwave energy (like a microwave oven or a cell phone, but stronger) at an object, most likely a cloud. Part of this beam of energy bounces back and is measured by the radar, providing information about the object. Radar can measure precipitation size, quantity, speed and direction of movement, within about 100 mile radius of its location.

![image](https://raw.githubusercontent.com/Fz3r0/Fz3r0_-_802.11_Wi-Fi_-_Knowledge-Base/refs/heads/main/Images/doppler%20radar.gif)

Doppler radar is a specific type of radar that uses the Doppler effect to gather velocity data from the particles that are being measured. For example, a Doppler radar transmits a signal that gets reflected off raindrops within a storm. The reflected radar signal is measured by the radar's receiver with a change in frequency. That frequency shift is directly related to the motion of the raindrops.

- `Distance to the location of the rain`: Calculated from the travel time of the electromagnetic wave from the transmitter until it returns to the sensor.
- `precipitation intensity`: Calculated from the amplitude of the reflected wave (the strength of echo)

![image](https://github.com/user-attachments/assets/7fd7c25d-d0a9-4b02-b9fb-9b56294413ab)

**Radar typical operation:**

1. Radar measures the distance to the target from the time of arrival of the scattered pulse.
2. When it receives a signal from a device sending a continuous wave (CW), such as telecommunication links, we see a line oriented radially toward the center of the radar image.
3. If the interfering transmitter is near the radar, we see the disturbance in a sector that can be as much as several tens of degrees wide _(eg. Wi-Fi lines or real weather lines in the last pictures)_.


### Radars: `Weather Signature` VS `Doppler Radar + Wi-Fi Interference`

The next screenshoot is from a typical weather Doppler Radar signature, it could be rain, snow etc. Meteorological Institutions are using these RADARs to detect atmospheric events in an area. So, for the below image, we can see some rain. This is a regular output for a rainy day(s):

![image](https://github.com/user-attachments/assets/a3876ccc-8c33-4937-90e3-7accda0479c9)

However, RADARs are using very very high gain antennas and they can pick up your very weak WiFi transmission. So, if not DFS rules are used, literally "blinds" the RADAR and it cannot see the atmosphere, it cannot work as expected.

In the next picture some "unnatural straight lines" are seen, that's 802.11 Wi-Fi signal without using DFS rules and "blinding" the RADAR:

![image](https://github.com/user-attachments/assets/637bc590-dfb7-49a2-9e69-e0197408a419)

**General Radar Operation**

1. A Radar-STA will transmit a set of powerful pulses periodically and observe the reflections.
2. Because the energy reflected back to the radar is much weaker than the original signal, the radar has to transmit a very powerful signal.
3. Also, because the energy reflected back to the radar is very weak, it could confuse it with other radio signals (like a wireless LAN to give an example).

**The general behavior of a device complying with the DFS protocol is:**

1. Being able to **detect** when a radar is occupying the channel
2. **Stop using that occupied channel**.
3. **Monitor** another channel
4. **jump** on it if it is ok. (eg. no radar there as well).

`Important`: The **process for a radio to detect a radar** is a complicated task that **is actually not part of the standard**. Hence, wrong radar detections can occur.

`Note`: _DFS is required for ETSI devices working in the European Union in the ETSI 5ghz band. It can be not mandatory in other parts of the world._

## DFS: 5 5ghz spectrum & radars

1.

![image](https://github.com/user-attachments/assets/0557d887-cf2a-4558-a3a2-dd7b77140599)

2.

![image](https://github.com/user-attachments/assets/a2da7f0a-63a8-4081-a4a0-3f9853dbc866)

![image](https://github.com/user-attachments/assets/4a4ccf8b-11c8-49fd-89c6-6448fe9fb77d)

3.

![image](https://github.com/user-attachments/assets/94388a6c-ede1-4cd6-b61c-38c69276e3c5)

## DFS: Frame Exchange

<img src="https://github.com/user-attachments/assets/26ab851f-c4e1-48eb-8deb-d3ef4e17d06e" width="300" height="300">

DFS operations use different ways of exchanging information between STAs. Information can be put in specific elements: 

1. Beacon
2. Probe Response
3. Action Frame (specific frame can also be used to report information) 








## DFS: Radar detection mechanism

When AP starts operation:

1. The AP automatically selects channels with low interference levels in a phase known as `Channel Availability Check (CAC)`.
2. During this phase, the access point is in a passive state scanning for radar signals _(This commonly takes one to two minutes, but could take up to ten minutes)_.
3. hereafter, the access point performs In-Service Monitoring (ISM) to detect active radar signals

If radar is detected by the AP:

1. AP broadcasts a `Action Frame: switch-channel event` to its clients and follows by switching the channel.
1. When the radio detects a radar, it must **stop using the channel** for **30 minutes at least** to protect that service.
2. It then **monitors another channel**
3. AP **start using that channel** **after at least 1 minute if no radar was detected**.



## Examples: 

![image](https://github.com/user-attachments/assets/0eeabed0-02b9-43c0-8099-d7268012f259)
















# TPC 

Initial 802.11h goal of TPC was to protect the **EESS (Earth Exploration Satellite Services)**, so the TPC ensures that the average power on the 802.11 device (AP/STA) is less than the regulatory domain maximun to reduce interference to the EESS. 

This means that:

- **The TPC mechanism limit the overall RF power/gain of 802.11 devices**, so they don't interfere with the EESS. 

But, the mechanism of power reduction it can be used for **other purposes**:

- **Nowdays TPC is used in ALL BANDS _(eg. 2.4 GHz & 5 GHz band)_ for reducing contention interference caused by client STAs. Mostly used for outdoor comunications.**

### TPC: `Legacy TPC`:`EESS (Earth Exploration Satellite Services)`

**Earth Exploration Satellite Systems (EESS)** are satellite services designed to monitor and study phenomena affecting Earth‚Äôs environment, including the atmosphere, land, and oceans. 

They use active and passive spaceborne sensors to collect data; active sensors emit signals and measure their reflection, while passive sensors capture natural emissions. 

Operating across frequencies from **432 MHz to 238 GHz**, EESS applications span climate monitoring, weather forecasting, agriculture, oceanography, disaster management, and environmental protection. 

Despite challenges like data transmission and interference, advancements include improved spatial resolution and machine learning for data analysis.

![image](https://github.com/user-attachments/assets/8c9692ba-0d14-41db-9b6a-5a62a5a73424)

- `Important`: 802.11h TPC was designed to prevent interference with EESS satellite systems, especially in the 5 GHz band, which EESS and 802.11 (Wi-Fi) can share. TPC helps adjust 802.11 devices' transmit power to minimize interference, protecting EESS operations. **However, today, TPC is primarily used to manage power efficiency and optimize network performance rather than for interference protection with satellite systems.** 

### TPC: `Modern TPC`:`Network Management`


































# Resources

- https://www.etsi.org/deliver/etsi_en/301800_301899/301893/01.08.01_60/en_301893v010801p.pdf
- https://journals.ametsoc.org/view/journals/bams/97/7/bams-d-15-00048.1.xml
- https://youtu.be/glqLGYaKU3g?si=I2iRcSIuO9ozLV4N
- https://mrncciew.com/2014/10/29/cwap-channel-switch-announcement/
- https://mrncciew.com/2014/10/09/802-11-mgmt-action-frames/
- https://community.cisco.com/t5/wireless-mobility-knowledge-base/tpc-and-dfs-overview/ta-p/3110379
- https://en.wikipedia.org/wiki/IEEE_802.11h-2003
- https://en.wikipedia.org/wiki/Dynamic_frequency_selection
- https://en.wikipedia.org/wiki/Power_control#Transmit_Power_Control
- https://www.youtube.com/watch?v=1x8odxiswz8
- https://oguzhaneren.com/2017/12/08/what-are-the-dfs-channels-and-how-are-they-dealing-with-radar-systems/
- https://www.researchgate.net/profile/Carmine-Massarelli/publication/358307051/figure/fig1/AS:1119418167898112@1643901497400/Weather-radar-principle-of-function-Weather-radar-image-reworked-from-source-7_Q320.jpg
- https://www.element.com/connected-technologies/dynamic-frequency-selection-dfs-testing-certification
- https://ecss.nl/item/?glossary_id=726
- https://telcomatraining.com/what-is-eess-earth-exploration-satellite-systems/



<p align="center"> <img src="https://github.com/user-attachments/assets/807020b5-82bd-4313-8213-99a4a646f226" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/288352d5-8e95-44c5-8a14-8ec490c841dc" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/a6c4fa0d-bc83-4fe1-aaf0-34e9b0156266" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/738d0c96-dec6-41d4-9deb-dc2f93f04df5" width="300" height="300"> 
<img src="https://github.com/user-attachments/assets/e5ceb6d6-c752-43a8-ab50-cfc592ccd49f" width="300" height="300">
<img src="https://github.com/user-attachments/assets/bbe05510-5d98-4fcb-ba25-a5110ccf78da" width="300" height="300"> </p>






---

<span align="center"> <p align="center"> ![giphy](https://user-images.githubusercontent.com/94720207/166587250-292d9a9f-e590-4c25-a678-d457e2268e85.gif) </p> </span> 



&nbsp;

<span align="center"> <p align="center"> _I hope this information was useful for someone_ </p> </span> 
<span align="center"> <p align="center"> _and please, don't forget to enjoy your days..._ </p> </span> 
<span align="center"> <p align="center"> _...It is getting dark... so dark..._ </p> </span> 

&nbsp;

<span align="center"> <p align="center"> _In the mist of the night you could see me come, where shadows move and Demons lie..._ </p> </span> 
<span align="center"> <p align="center"> _I am [Fz3r0 üíÄ](https://github.com/Fz3r0/) and the Sun no longer rises..._ </p> </span> 

---






---

> ![hecho en mexico 5](https://user-images.githubusercontent.com/94720207/166068790-fa1f243d-2db9-4810-a6e4-eb3c4ad23700.png)
>
> _- Hecho en M√©xico - by [Fz3r0 üíÄ](https://github.com/Fz3r0/)_  
>
> _"In the mist of the night you could see me come, where shadows move and Demons lie..."_ 
