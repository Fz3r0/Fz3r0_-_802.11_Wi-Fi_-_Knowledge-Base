
# üôãüõúüö¶MAC Operations: `802.11k/v/r` - `Roaming` , `Neighbor Report` , `Band Balance` , `Load Balance`

![My Video](https://user-images.githubusercontent.com/94720207/165892585-b830998d-d7c5-43b4-a3ad-f71a07b9077e.gif)

### üê¶ Twitter  : [@fz3r0_OPs](https://twitter.com/Fz3r0_OPs)  || üê± Github  : [Fz3r0](https://github.com/fz3r0) 

---
 
#### Keywords: `Networking` `Wireless Networking` `IEEE 802.11` `Wi-Fi` `CWNA` `CWAP` `CWNE` `CCNP` `MAC Operations` `DFS` `DFS Protection`

---

<br>

# Index




# MAC Operations: `802.11k/v/r` - `Roaming` , `Neighbor Report` , `Band Balance` , `Load Balance`




- `802.11k - Radio Resource Measurement (RRM)`:  Informs client STAs of the WLAN RF information such as the AP **Channel** and **RSSI**. **Neighbor Report Requests** & **Neighbor Report Responses** exchange this info between STAs. 
This allows clients to make more informed roaming decisions. Ultimately, **client STAs still make the final roaming decision.** 

- `802.11v - Wireless Network Management (WNM)`: allows the **AP to suggest roaming decisions to clients**. These decisions are based on **load of total clients** as well as **channel conditions** supplied with **`802.11k` neighbor reports**.

- `802.11r - Fast Transition (FT)`:

This means: 

- **802.22k informs clients for roaming decisions whereas 802.11v manages roams based on AP determination (using information from 802.11k).**

As a result, using 802.11v is more likely to disrupt network access if the behavior isn't understood with the clients you're supporting.























# WNM: 802.11v - WNM (Wireless Network Management)

- Includes a few amandfments, but known as BSS Transition Management
- BSS Transition Management Request & Responses manage sTAs between BSSIDs
- Incorporates 802.11k neoighbor reports. 

## RRM: Frame exchange

Beacons

- `BSS Trasnition`

Filter

BTM Request and Responses:

- `wlan.fixed.action_code in {0x07,0x08}`






























# `802.11k - Radio Resource Measurement (RRM)`

**IEEE 802.11k-2008** is an amendment to IEEE 802.11-2007 standard for `Radio Resource Measurement (RRM)`. 

- It defines and exposes radio and network information to facilitate the **management and maintenance of a mobile Wireless LAN**.

## 802.11k: `RRM Information Element`

RRM IE Is present in:


- `Neighbor Reports (Action Frames)` inform client STAs of BSSID RF Conditions
- Client STAs ask for specific SSID info in Neigbor Requests
- Responses tell clients the AP channel for RF conditions

## RRM: Frame exchange



- RM Enables Capabilites:  `wlan.fixed.action_code in {0x04,0x05}`
- RM Enables Capabilites: in beacons
- Probe Response

If there is no** RM Enabled Capability Information Element (IE)** then **802.11k is NOT enabled on that SSID**. If it is there then I think you can safely assume 802.11k is supported, but more specifically you can check to see if Neighbor Reports is Enabled under the first RM Capabilities octet:


### Action Frame: `Neighbor Report Response`

````sh
# Action Frame > Neighbor Report Response

802.11 radio information
IEEE 802.11 Action, Flags: ........
    Type/Subtype: Action (0x000d)
    Frame Control Field: 0xd000

    Transmitter address: AP1_f0:f0:f0 (AP1_f0:f0:f0)
    BSS Id: AP1_f0:f0:f0 (AP1_f0:f0:f0)

IEEE 802.11 Wireless Management

    Fixed parameters
        Category code: Radio Measurement (5)
        Action code: Neighbor Report Response (5)
        Dialog token: 21

    Tagged parameters (161 bytes)
        Tag: Neighbor Report
            Tag Number: Neighbor Report (52)
            Tag length: 21
            BSSID: AP2_f2:f2:f2 (AP2_f2:f2:f2)
            BSSID Information: 0x0000dc97
                .... .... .... .... .... .... .... ..11 = AP Reachability: Reachable (0x3)
                .... .... .... .... .... .... .... .1.. = Security: True
                .... .... .... .... .... .... .... 0... = Key Scope: False
                .... .... .... .... .... ..00 1001 .... = Capability: 0x09
                .... .... .... .... .... .1.. .... .... = Mobility Domain: True
                .... .... .... .... .... 1... .... .... = High Throughput Control (+HTC): True
                .... .... .... .... ...1 .... .... .... = Very High Throughput (+VHT): True
                .... .... .... .... ..0. .... .... .... = Fine Timing Measurement (FTM): False
                .... .... .... .... .1.. .... .... .... = High Efficiency (HE AP): True
                .... .... .... .... 1... .... .... .... = Extended Range BSS: True
                .... .... .... ...0 .... .... .... .... = Co-Located AP: False
                .... .... .... ..0. .... .... .... .... = Unsolicited Probe Responses Active: False
                .... .... .... .0.. .... .... .... .... = Members Of ESS With 2.4/5 GHz Co-Located AP: False
                .... .... .... 0... .... .... .... .... = OCT Supported With Reporting AP: False
                .... .... ...0 .... .... .... .... .... = Co-Located With 6 GHz AP: False
                .... .... ..0. .... .... .... .... .... = Extremely High Throughput: False
                0000 0000 00.. .... .... .... .... .... = Reserved: 0x000
            Operating Class: 121
            Channel Number: 100 (iterative measurements on that Channel Number)
            PHY Type: 0x0e
            Subelement: Wide Bandwidth Channel
                ID: 6
                Length: 3
                Data: 006400
            Subelement: BSS Transition Candidate Preference
                ID: 3
                Length: 1
                Preference: 0
````

### Action Frame: `Radio Resource Measurement`

````
# Action Frame > Radio Resource Measurement

802.11 radio information
IEEE 802.11 Action, Flags: ........
    Type/Subtype: Action (0x000d)
    Frame Control Field: 0xd000

    Destination address: Alice_a1:a1:a1 (Alice_a1:a1:a1)
    Transmitter address: AP1_f0:f0:f0 (AP1_f0:f0:f0)
    BSS Id: AP1_f0:f0:f0 (AP1_f0:f0:f0)

IEEE 802.11 Wireless Management

    Fixed parameters
        Category code: Radio Measurement (5)
        Action code: Neighbor Report Request (4)
        Dialog token: 21

    Tagged parameters (13 bytes)
        Tag: SSID parameter set: "Fz3r0::CWAP"
                                  
            Tag Number: SSID parameter set (0)
            Tag length: 11
            SSID: "Fz3r0::CWAP"

````

## 802.11k: `Assisted Roaming`


This standard improves network performance by helping client devices to search faster the nearest access point available, based on its active users and overall traffic. The client devices continuously scan the nearest access points and their channels. Also, it provides optimized signal strength management while decreasing the amount of time needed to find neighboring access points. In this way, the end-user has a better roaming experience.

For instance, when a client device detects an AP close in proximity but with high traffic versus an AP with less traffic but not close in proximity, the standard 802.11k would suggest using the latter AP, due to its faster network throughput. In the case, the signal strength of the current access point debilitates, the client device immediately finds another access point from the network list.



## 802.11k: `Frame Exchange`

_In this frame exchange example 802.11k will be used for roaming from AP-1 to AP-2_

**802.11k assists client STAs in identifying nearby APs**, minimizing the need for off-channel scanning during the decision-making process of which AP to roam to next. When necessary, the client can request a neighbor report that provides a list of nearby APs.

**802.11k** is used within **802.11r** that improves roaming efficiency in Wi-Fi networks, enabling client STAs to identify nearby APs without conducting a full channel scan, thereby reducing disconnection time and enhancing mobility experience.

#### 1. Roaming Scenario Initiation

- The client STA detects that the signal quality with the current AP has degraded, either due to distance or interference.
- To optimize the transition to a neighboring AP without performing a complete manual channel scan, the STA considers requesting a Neighbor Report from the current AP.

#### 2. Neighbor Report Request:

- The client STA sends a specific 802.11k Action Frame to the AP, with a subfield indicating a Neighbor Report Request.
- This formal request allows the AP to prepare and provide a list of neighboring APs that meet specific criteria (e.g., same ESSID and available for roaming).
- This step prevents the client from having to scan all channels, which can interrupt data flow.

#### 3. AP Response with Neighbor Report

- After receiving the STA‚Äôs request, the AP reviews its configured neighbor list and responds with a Neighbor Report Response, containing a list of recommended neighboring APs.
- Each entry in the neighbor report includes the MAC address of neighboring APs, their channels, and other relevant information for roaming, such as the availability of 802.11r (Fast Transition).

#### 4. Client STA Evaluation:

- The client STA analyzes the received list of neighboring APs and determines which AP has the best characteristics for roaming.
- Based on signal quality and other parameters, it decides on the next AP to attempt a connection with, reducing the need for active scanning across all channels.

#### 5. Roaming Process:

- Using the information provided by the Neighbor Report, the client STA selects an appropriate AP and initiates an authentication and association process with the new AP.
- If the environment also supports 802.11r, the roaming process will be further optimized to reduce re-authentication latency.




802.11v:

Imagine a wireless mobile device having trouble sending or receiving data because it's too far from the access point (AP).

Access Point: Hello there, my dear mobile device. Why are you struggling here instead of moving to another AP?

Wireless Mobile: I'm just being loyal üòÖ.

Access Point: Well, keep your loyalty in your pocket. Here‚Äôs the best AP nearby for you to connect to. Go and connect, no need to struggle here.

Wireless Mobile: Hehe, thanks! Bye üëãüèª.

802.11v BSS Transition Management enables an access point (AP) to recommend or request that a device switch to a different AP, often to balance the network load or if the current AP can no longer maintain the connection. This helps the device choose the best AP from a list of suggested options. In networks where APs can talk to each other, this process becomes more dependable. APs track the device's signal strength (RSSI) using Probe requests to ensure a strong connection.

802.11r:

Access Point: So, you've finally decided to move on üíî.

Wireless Mobile: Yeah, but I need to authenticate with the RADIUS server again, and that takes so much time ü•≤.

Access Point: Don‚Äôt worry, I can do you a last favor so you can skip the authentication and connect to another AP in under 50ms.

Wireless Mobile: That‚Äôs so sweet of you! But how can we do that?

Access Point: Just tell the neighboring AP that you‚Äôre my client and share the PMKID. Then, use PMKR1 to generate the PTK.Remember, these are secret codes which will help authenticate!

Wireless Mobile: Cool, thanks for the tip. I‚Äôll miss you though üòïüíî.

802.11r speeds up client roaming between APs by allowing clients to skip reauthentication with the RADIUS server. The secret keys can be exchanged over air/backend.






##  802.11k/r Information Elements

















# `802.11v - Wireless Network Management (WNM)`

What about 802.11r? Do we have the same naming confusing? Of course we do!!!

Again, the working group was 802.11r but the feature is known as ‚ÄòFast BSS Transition‚Äô or ‚ÄòFast Transition‚Äò. Cisco refer to it as ‚ÄòFast Transition‚Äô and Aruba refers to is as ‚Äò802.11r‚Äô.

So what about the beacon information element? Consistent? Similar? Nope!

The beacon IE itself is called ‚ÄúMobility Domain‚Äú. Easily confused with the very similar exactly same language used for a completely unrelated function within Cisco (to be clear, Cisco used the term before 802.11 did I believe). Once you dig into the Mobility Domain IE you will then see the terms ‚ÄòFT‚Äô and ‚ÄòFast BSS Transition‚Äô being used.

If you do not see the Mobility Domain IE then the SSID does NOT support 802.11r. If it does exist, then you need to expand out the ‚ÄòFT Capability and Policy‚Äô sub-element to identify whether the SSID is using ‚ÄòFT Over the Air‚Äô or ‚ÄòFT Over the DS‚Äô. But you won‚Äôt find two separate settings, this is a binary decision, one or the other must be used. Therefore the parameter ‚ÄòFast BSS Transition over DS‚Äô is used to indicate which it is; Enabled obviously means that Over the DS is used, and disabled can be surmised as Over The Air is used.

Here is what it looks like within Wireshark, including the sub-element identifying that the SSID uses FT ‚ÄòOver The DS‚Äô.


Here is what it looks like within Wireshark, including the sub-element identifying that the SSID uses FT ‚ÄòOver The Air‚Äô (because Over The DS is disabled).


Here is what it looks like within Omnipeek, including the sub-element identifying that the SSID uses FT ‚ÄòOver The DS‚Äô.


Here is what it looks like within Wireshark, including the sub-element identifying that the SSID uses FT ‚ÄòOver The Air‚Äô.


Hope that helps someone. As always, any comments welcome. And if you spot anything I‚Äôve got wrong please let me know!










## Over the air present in:

Beacon
Probe Response
RSN Information Element
AKM List
















# Resources

- https://www.youtube.com/watch?v=4Ua2lI6HBhE
- https://www.youtube.com/watch?v=p_K9xHxFM8Y
- https://mac-wifi.com/how-to-verify-whether-802-11k-and-11r-are-enabled-via-a-capture/
- https://www.linkedin.com/posts/wi-fi-nomads_wifi-11kvr-wifinomads-activity-7235988334072737792-MkLY/?utm_source=share&utm_medium=member_android
- https://support.apple.com/es-lamr/guide/deployment/dep98f116c0f/web
- https://www.linkedin.com/posts/santoseva_comparing-80211k-vs-80211v-for-roaming-activity-7243993630145716225-poRO/?utm_source=share&utm_medium=member_desktop
- https://www.mist.com/documentation/802-11k-802-11r-802-11v/
- https://www.wifrizzy.com/post/is-802-11v-problematic
- https://en.wikipedia.org/wiki/IEEE_802.11k-2008
- https://en.wikipedia.org/wiki/IEEE_802.11v-2011
- https://mrncciew.com/2014/09/02/cwsp-802-11-roaming-basics/
- https://mrncciew.com/2020/12/10/fast-roaming-lessons/
- https://www.tanaza.com/wifi-fast-roaming/

---

<span align="center"> <p align="center"> ![giphy](https://user-images.githubusercontent.com/94720207/166587250-292d9a9f-e590-4c25-a678-d457e2268e85.gif) </p> </span> 



&nbsp;

<span align="center"> <p align="center"> _I hope this information was useful for someone_ </p> </span> 
<span align="center"> <p align="center"> _and please, don't forget to enjoy your days..._ </p> </span> 
<span align="center"> <p align="center"> _...It is getting dark... so dark..._ </p> </span> 

&nbsp;

<span align="center"> <p align="center"> _In the mist of the night you could see me come, where shadows move and Demons lie..._ </p> </span> 
<span align="center"> <p align="center"> _I am [Fz3r0 üíÄ](https://github.com/Fz3r0/) and the Sun no longer rises..._ </p> </span> 

---






---

> ![hecho en mexico 5](https://user-images.githubusercontent.com/94720207/166068790-fa1f243d-2db9-4810-a6e4-eb3c4ad23700.png)
>
> _- Hecho en M√©xico - by [Fz3r0 üíÄ](https://github.com/Fz3r0/)_  
>
> _"In the mist of the night you could see me come, where shadows move and Demons lie..."_ 
