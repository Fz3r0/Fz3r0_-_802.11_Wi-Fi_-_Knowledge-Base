## 4-way-handshake






---

# PMK (Pairwise Master Key)

- The PMK (Pairwise Master Key) is a key used in WPA (Wi-Fi Protected Access) security protocols to establish secure communication between a client (such as a laptop or smartphone) and an access point (such as a Wi-Fi router).
- The PMK serves as the foundation for deriving further encryption keys, such as the PTK (Pairwise Transient Key) and GTK (Group Temporal Key), which are used for securing individual and group communications in a Wi-Fi network.
- The PMK is never transmitted over the network; instead, it is independently derived by both the Access Point (AP) and the Station (STA) using the same method. For secure communication, the PMK generated by both parties must match, ensuring successful authentication and enabling secure data transmission.

## PMK Summary

- PMK Size: 256 bits (32 bytes).
- Derivation Method: PBKDF2 with HMAC-SHA1 (WPA2-Personal) // Derived from the MSK (802.1X-Enterprise) // SAE Handshake (WPA3-Personal).
- Created by Authenticator (AP) & Supplicant (STA) independently, they should match with each other.
- Never transmitted over the network

### Example of PMK:

- `PMK Raw Binary Format`: In memory, the PMK might be stored as a byte array. For example, a PMK could look like this in raw binary format:

````sh
b'\x3A\x5B\x7C\x9D\xAE\xBF\xC1\xD2\xE3\xF4\x65\x76\x87\x98\xA9\xBA' \
b'\xCB\xDC\xED\xFE\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A'
````

- `PMK Hexadecimal Format`: When displayed or logged, the PMK is typically shown in hexadecimal format:

````sh
3A:5B:7C:9D:AE:BF:C1:D2:E3:F4:65:76:87:98:A9:BA:CB:DC:ED:FE:10:11:12:13:14:15:16:17:18:19:1A
````

## PMK Derivation

PMK derivation refers to the process of generating the PMK from a shared secret (like a pre-shared key) or from an authentication method (like EAP in 802.1X).

### WPA2-Personal (PSK): 

The PMK is derived from a Pre-Shared Key (PSK), typically using a process like PBKDF2 with HMAC-SHA1 to transform the passphrase and SSID into a secure key.

### WPA2-Enterprise (802.1X): 

The PMK is derived from the Master Session Key (MSK), which is generated during the EAP (Extensible Authentication Protocol) authentication process. The PMK in this case is the first 256 bits of the MSK.

### WPA3-Personal: 

The PMK is derived from the SAE (Simultaneous Authentication of Equals) handshake, which is based on elliptic-curve cryptography and does not directly use the password.

## PMK: `WPA2-Personal (PSK)`

- In WPA2-Personal, The PMK is derived using the PBKDF2 (Password-Based Key Derivation Function 2) algorithm, often with HMAC-SHA1.
- The function is applied multiple times (e.g., 4096 iterations) to make brute-force attacks more difficult.

### PBKDF2 PMK Inputs:

- `Passphrase (WPA)`: User's WPA2 passphrase
- `Salt`: Network SSID.
- `Iterations`: 4096 rounds of HMAC-SHA1.
- `Output`: 256-bit PMK used for subsequent key derivations (like PTK and GTK) in the WPA2 authentication process.

### PBKDF2 derivation formula

- **PMK = PBKDF2(HMAC-SHA1, PSK, SSID(salt), rounds=4096, dklen=32)**

### PMK derivation using PBKDF2: `Python`

````py
# PMK Key Generator in Python by Fz3r0

import hashlib
import binascii

# Function to derive the PMK using PBKDF2 with HMAC-SHA1
def generate_pmk(password, ssid, iterations=4096, dklen=32):

    """
    Generates the PMK (Pairwise Master Key) using PBKDF2 with HMAC-SHA1.

    :param password:   Wi-Fi password (preshared key)
    :param ssid:       Wi-Fi network name (SSID)
    :param iterations: Number of iterations (default 4096)
    :param dklen:      Desired length of the derived key (32 bytes = 256 bits by default)
    :return:           PMK in hexadecimal format
    """

    # Ensure that the password and SSID are in byte format
    password_bytes = password.encode('utf-8')  # Converts password to bytes
    ssid_bytes = ssid.encode('utf-8')          # Converts SSID to bytes
    
    # Use PBKDF2 with HMAC-SHA1 to derive the key
    # 'sha1' is the hashing algorithm, password_bytes is the input key,
    # ssid_bytes is the salt, iterations is the number of rounds,
    # and dklen is the desired key length (32 bytes)
    pmk = hashlib.pbkdf2_hmac('sha1', password_bytes, ssid_bytes, iterations, dklen)
    
    # Convert the PMK to hexadecimal format for better readability
    return binascii.hexlify(pmk).decode().upper()

# Example usage
password = "password123"  # Wi-Fi password (pre-shared key)
ssid = "ExampleSSID"      # Wi-Fi network SSID

# Generate the PMK using the password and SSID
pmk = generate_pmk(password, ssid)

# Print the resulting PMK in hexadecimal format
print(f"PMK: {pmk}")

````

## PMK using 802.1X-EAP (Enterprise)

- In WPA2-Enterprise (802.1X), the PMK is derived from the MSK generated during the EAP process, so PBKDF2 is not used.

### PMK using WPA3

- One of the key differences between WPA2 and WPA3 is how the PMK (Pairwise Master Key) is derived, particularly in WPA3-Personal.
- In WPA2-Personal, the PMK is derived from a pre-shared key (PSK), while in WPA3-Personal, the PSK mechanism is replaced by SAE (Simultaneous Authentication of Equals).
- SAE is a password-based key exchange protocol that uses elliptic-curve cryptography (Dragonfly handshake) to derive the PMK, without transmitting or directly using the password.
- After the SAE handshake establishes the PMK, WPA3 still uses a 4-way handshake, much like WPA2, to derive other keys like the PTK (Pairwise Transient Key) and the GTK (Group Temporal Key).

### PMK Summary



